import{__assign as t}from"../../../../../tslib/tslib.es6.js";import{invariant as i}from"../../../../../hey-listen/dist/hey-listen.es.js";import{PanSession as n}from"../PanSession.mjs.js";import{getGlobalLock as o}from"./utils/lock.mjs.js";import{isRefObject as s}from"../../utils/is-ref-object.mjs.js";import{addPointerEvent as r}from"../../events/use-pointer-event.mjs.js";import{applyConstraints as e,calcRelativeConstraints as a,resolveDragElastic as l,calcViewportConstraints as u,rebaseAxisConstraints as c,calcOrigin as p,defaultElastic as m}from"./utils/constraints.mjs.js";import{AnimationType as v}from"../../render/utils/types.mjs.js";import{createBox as g}from"../../projection/geometry/models.mjs.js";import{eachAxis as d}from"../../projection/utils/each-axis.mjs.js";import{measurePageBox as h}from"../../projection/utils/measure.mjs.js";import{extractEventInfo as f}from"../../events/event-info.mjs.js";import{startAnimation as j}from"../../animation/utils/transitions.mjs.js";import{convertBoxToBoundingBox as y,convertBoundingBoxToBox as P}from"../../projection/geometry/conversion.mjs.js";import{addDomEvent as E}from"../../events/use-dom-event.mjs.js";import{calcLength as x}from"../../projection/geometry/delta-calc.mjs.js";import{percent as D}from"../../../../../style-value-types/dist/es/numbers/units.mjs.js";import{mix as A}from"../../../../../popmotion/dist/es/utils/mix.mjs.js";var C=new WeakMap,M=function(){function M(t){this.openGlobalLock=null,this.isDragging=!1,this.currentDirection=null,this.originPoint={x:0,y:0},this.constraints=!1,this.hasMutatedConstraints=!1,this.elastic=g(),this.visualElement=t}return M.prototype.start=function(t,i){var s=this,r=(void 0===i?{}:i).snapToCursor,e=void 0!==r&&r;if(!1!==this.visualElement.isPresent){this.panSession=new n(t,{onSessionStart:function(t){s.stopAnimation(),e&&s.snapToCursor(f(t,"page").point)},onStart:function(t,i){var n,r=s.getProps(),e=r.drag,a=r.dragPropagation,l=r.onDragStart;(!e||a||(s.openGlobalLock&&s.openGlobalLock(),s.openGlobalLock=o(e),s.openGlobalLock))&&(s.isDragging=!0,s.currentDirection=null,s.resolveConstraints(),s.visualElement.projection&&(s.visualElement.projection.isAnimationBlocked=!0,s.visualElement.projection.target=void 0),d((function(t){var i,n,o=s.getAxisMotionValue(t).get()||0;if(D.test(o)){var r=null===(n=null===(i=s.visualElement.projection)||void 0===i?void 0:i.layout)||void 0===n?void 0:n.actual[t];if(r)o=x(r)*(parseFloat(o)/100)}s.originPoint[t]=o})),null==l||l(t,i),null===(n=s.visualElement.animationState)||void 0===n||n.setActive(v.Drag,!0))},onMove:function(t,i){var n=s.getProps(),o=n.dragPropagation,r=n.dragDirectionLock,e=n.onDirectionLock,a=n.onDrag;if(o||s.openGlobalLock){var l=i.offset;if(r&&null===s.currentDirection)return s.currentDirection=function(t,i){void 0===i&&(i=10);var n=null;Math.abs(t.y)>i?n="y":Math.abs(t.x)>i&&(n="x");return n}(l),void(null!==s.currentDirection&&(null==e||e(s.currentDirection)));s.updateAxis("x",i.point,l),s.updateAxis("y",i.point,l),s.visualElement.syncRender(),null==a||a(t,i)}},onSessionEnd:function(t,i){return s.stop(t,i)}},{transformPagePoint:this.visualElement.getTransformPagePoint()})}},M.prototype.stop=function(t,i){var n=this.isDragging;if(this.cancel(),n){var o=i.velocity;this.startAnimation(o);var s=this.getProps().onDragEnd;null==s||s(t,i)}},M.prototype.cancel=function(){var t,i;this.isDragging=!1,this.visualElement.projection&&(this.visualElement.projection.isAnimationBlocked=!1),null===(t=this.panSession)||void 0===t||t.end(),this.panSession=void 0,!this.getProps().dragPropagation&&this.openGlobalLock&&(this.openGlobalLock(),this.openGlobalLock=null),null===(i=this.visualElement.animationState)||void 0===i||i.setActive(v.Drag,!1)},M.prototype.updateAxis=function(t,i,n){var o=this.getProps().drag;if(n&&L(t,o,this.currentDirection)){var s=this.getAxisMotionValue(t),r=this.originPoint[t]+n[t];this.constraints&&this.constraints[t]&&(r=e(r,this.constraints[t],this.elastic[t])),s.set(r)}},M.prototype.resolveConstraints=function(){var t=this,i=this.getProps(),n=i.dragConstraints,o=i.dragElastic,r=(this.visualElement.projection||{}).layout,e=this.constraints;n&&s(n)?this.constraints||(this.constraints=this.resolveRefConstraints()):this.constraints=!(!n||!r)&&a(r.actual,n),this.elastic=l(o),e!==this.constraints&&r&&this.constraints&&!this.hasMutatedConstraints&&d((function(i){t.getAxisMotionValue(i)&&(t.constraints[i]=c(r.actual[i],t.constraints[i]))}))},M.prototype.resolveRefConstraints=function(){var t=this.getProps(),n=t.dragConstraints,o=t.onMeasureDragConstraints;if(!n||!s(n))return!1;var r=n.current;i(null!==r,"If `dragConstraints` is set as a React ref, that ref must be passed to another component's `ref` prop.");var e=this.visualElement.projection;if(!e||!e.layout)return!1;var a=h(r,e.root,this.visualElement.getTransformPagePoint()),l=u(e.layout.actual,a);if(o){var c=o(y(l));this.hasMutatedConstraints=!!c,c&&(l=P(c))}return l},M.prototype.startAnimation=function(i){var n=this,o=this.getProps(),s=o.drag,r=o.dragMomentum,e=o.dragElastic,a=o.dragTransition,l=o.dragSnapToOrigin,u=o.onDragTransitionEnd,c=this.constraints||{},p=d((function(o){var u;if(L(o,s,n.currentDirection)){var p=null!==(u=null==c?void 0:c[o])&&void 0!==u?u:{};l&&(p={min:0,max:0});var m=e?200:1e6,v=e?40:1e7,g=t(t({type:"inertia",velocity:r?i[o]:0,bounceStiffness:m,bounceDamping:v,timeConstant:750,restDelta:1,restSpeed:10},a),p);return n.startAxisValueAnimation(o,g)}}));return Promise.all(p).then(u)},M.prototype.startAxisValueAnimation=function(t,i){var n=this.getAxisMotionValue(t);return j(t,n,0,i)},M.prototype.stopAnimation=function(){var t=this;d((function(i){return t.getAxisMotionValue(i).stop()}))},M.prototype.getAxisMotionValue=function(t){var i,n,o="_drag"+t.toUpperCase(),s=this.visualElement.getProps()[o];return s||this.visualElement.getValue(t,null!==(n=null===(i=this.visualElement.getProps().initial)||void 0===i?void 0:i[t])&&void 0!==n?n:0)},M.prototype.snapToCursor=function(t){var i=this;d((function(n){if(L(n,i.getProps().drag,i.currentDirection)){var o=i.visualElement.projection,s=i.getAxisMotionValue(n);if(o&&o.layout){var r=o.layout.actual[n],e=r.min,a=r.max;s.set(t[n]-A(e,a,.5))}}}))},M.prototype.scalePositionWithinConstraints=function(){var t,i=this,n=this.getProps(),o=n.drag,r=n.dragConstraints,e=this.visualElement.projection;if(s(r)&&e&&this.constraints){this.stopAnimation();var a={x:0,y:0};d((function(t){var n=i.getAxisMotionValue(t);if(n){var o=n.get();a[t]=p({min:o,max:o},i.constraints[t])}}));var l=this.visualElement.getProps().transformTemplate;this.visualElement.getInstance().style.transform=l?l({},""):"none",null===(t=e.root)||void 0===t||t.updateScroll(),e.updateLayout(),this.resolveConstraints(),d((function(t){if(L(t,o,null)){var n=i.getAxisMotionValue(t),s=i.constraints[t],r=s.min,e=s.max;n.set(A(r,e,a[t]))}}))}},M.prototype.addListeners=function(){var t,i=this;C.set(this.visualElement,this);var n=this.visualElement.getInstance(),o=r(n,"pointerdown",(function(t){var n=i.getProps(),o=n.drag,s=n.dragListener;o&&(void 0===s||s)&&i.start(t)})),e=function(){var t=i.getProps().dragConstraints;s(t)&&(i.constraints=i.resolveRefConstraints())},a=this.visualElement.projection,l=a.addEventListener("measure",e);a&&!a.layout&&(null===(t=a.root)||void 0===t||t.updateScroll(),a.updateLayout()),e();var u=E(window,"resize",(function(){return i.scalePositionWithinConstraints()}));return a.addEventListener("didUpdate",(function(t){var n=t.delta,o=t.hasLayoutChanged;i.isDragging&&o&&(d((function(t){var o=i.getAxisMotionValue(t);o&&(i.originPoint[t]+=n[t].translate,o.set(o.get()+n[t].translate))})),i.visualElement.syncRender())})),function(){u(),o(),l()}},M.prototype.getProps=function(){var i=this.visualElement.getProps(),n=i.drag,o=void 0!==n&&n,s=i.dragDirectionLock,r=void 0!==s&&s,e=i.dragPropagation,a=void 0!==e&&e,l=i.dragConstraints,u=void 0!==l&&l,c=i.dragElastic,p=void 0===c?m:c,v=i.dragMomentum,g=void 0===v||v;return t(t({},i),{drag:o,dragDirectionLock:r,dragPropagation:a,dragConstraints:u,dragElastic:p,dragMomentum:g})},M}();function L(t,i,n){return!(!0!==i&&i!==t||null!==n&&n!==t)}export{M as VisualElementDragControls,C as elementDragControls};
//# sourceMappingURL=VisualElementDragControls.mjs.js.map
