"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("../../../../../tslib/tslib.es6.js"),i=require("../../../../../hey-listen/dist/hey-listen.es.js"),n=require("../PanSession.mjs.js"),e=require("./utils/lock.mjs.js"),s=require("../../utils/is-ref-object.mjs.js"),o=require("../../events/use-pointer-event.mjs.js"),r=require("./utils/constraints.mjs.js"),a=require("../../render/utils/types.mjs.js"),l=require("../../projection/geometry/models.mjs.js"),u=require("../../projection/utils/each-axis.mjs.js"),c=require("../../projection/utils/measure.mjs.js"),p=require("../../events/event-info.mjs.js"),v=require("../../animation/utils/transitions.mjs.js"),g=require("../../projection/geometry/conversion.mjs.js"),d=require("../../events/use-dom-event.mjs.js"),m=require("../../projection/geometry/delta-calc.mjs.js"),h=require("../../../../../style-value-types/dist/es/numbers/units.mjs.js"),f=require("../../../../../popmotion/dist/es/utils/mix.mjs.js"),j=new WeakMap,x=function(){function x(t){this.openGlobalLock=null,this.isDragging=!1,this.currentDirection=null,this.originPoint={x:0,y:0},this.constraints=!1,this.hasMutatedConstraints=!1,this.elastic=l.createBox(),this.visualElement=t}return x.prototype.start=function(t,i){var s=this,o=(void 0===i?{}:i).snapToCursor,r=void 0!==o&&o;if(!1!==this.visualElement.isPresent){this.panSession=new n.PanSession(t,{onSessionStart:function(t){s.stopAnimation(),r&&s.snapToCursor(p.extractEventInfo(t,"page").point)},onStart:function(t,i){var n,o=s.getProps(),r=o.drag,l=o.dragPropagation,c=o.onDragStart;(!r||l||(s.openGlobalLock&&s.openGlobalLock(),s.openGlobalLock=e.getGlobalLock(r),s.openGlobalLock))&&(s.isDragging=!0,s.currentDirection=null,s.resolveConstraints(),s.visualElement.projection&&(s.visualElement.projection.isAnimationBlocked=!0,s.visualElement.projection.target=void 0),u.eachAxis((function(t){var i,n,e=s.getAxisMotionValue(t).get()||0;if(h.percent.test(e)){var o=null===(n=null===(i=s.visualElement.projection)||void 0===i?void 0:i.layout)||void 0===n?void 0:n.actual[t];if(o)e=m.calcLength(o)*(parseFloat(e)/100)}s.originPoint[t]=e})),null==c||c(t,i),null===(n=s.visualElement.animationState)||void 0===n||n.setActive(a.AnimationType.Drag,!0))},onMove:function(t,i){var n=s.getProps(),e=n.dragPropagation,o=n.dragDirectionLock,r=n.onDirectionLock,a=n.onDrag;if(e||s.openGlobalLock){var l=i.offset;if(o&&null===s.currentDirection)return s.currentDirection=function(t,i){void 0===i&&(i=10);var n=null;Math.abs(t.y)>i?n="y":Math.abs(t.x)>i&&(n="x");return n}(l),void(null!==s.currentDirection&&(null==r||r(s.currentDirection)));s.updateAxis("x",i.point,l),s.updateAxis("y",i.point,l),s.visualElement.syncRender(),null==a||a(t,i)}},onSessionEnd:function(t,i){return s.stop(t,i)}},{transformPagePoint:this.visualElement.getTransformPagePoint()})}},x.prototype.stop=function(t,i){var n=this.isDragging;if(this.cancel(),n){var e=i.velocity;this.startAnimation(e);var s=this.getProps().onDragEnd;null==s||s(t,i)}},x.prototype.cancel=function(){var t,i;this.isDragging=!1,this.visualElement.projection&&(this.visualElement.projection.isAnimationBlocked=!1),null===(t=this.panSession)||void 0===t||t.end(),this.panSession=void 0,!this.getProps().dragPropagation&&this.openGlobalLock&&(this.openGlobalLock(),this.openGlobalLock=null),null===(i=this.visualElement.animationState)||void 0===i||i.setActive(a.AnimationType.Drag,!1)},x.prototype.updateAxis=function(t,i,n){var e=this.getProps().drag;if(n&&y(t,e,this.currentDirection)){var s=this.getAxisMotionValue(t),o=this.originPoint[t]+n[t];this.constraints&&this.constraints[t]&&(o=r.applyConstraints(o,this.constraints[t],this.elastic[t])),s.set(o)}},x.prototype.resolveConstraints=function(){var t=this,i=this.getProps(),n=i.dragConstraints,e=i.dragElastic,o=(this.visualElement.projection||{}).layout,a=this.constraints;n&&s.isRefObject(n)?this.constraints||(this.constraints=this.resolveRefConstraints()):this.constraints=!(!n||!o)&&r.calcRelativeConstraints(o.actual,n),this.elastic=r.resolveDragElastic(e),a!==this.constraints&&o&&this.constraints&&!this.hasMutatedConstraints&&u.eachAxis((function(i){t.getAxisMotionValue(i)&&(t.constraints[i]=r.rebaseAxisConstraints(o.actual[i],t.constraints[i]))}))},x.prototype.resolveRefConstraints=function(){var t=this.getProps(),n=t.dragConstraints,e=t.onMeasureDragConstraints;if(!n||!s.isRefObject(n))return!1;var o=n.current;i.invariant(null!==o,"If `dragConstraints` is set as a React ref, that ref must be passed to another component's `ref` prop.");var a=this.visualElement.projection;if(!a||!a.layout)return!1;var l=c.measurePageBox(o,a.root,this.visualElement.getTransformPagePoint()),u=r.calcViewportConstraints(a.layout.actual,l);if(e){var p=e(g.convertBoxToBoundingBox(u));this.hasMutatedConstraints=!!p,p&&(u=g.convertBoundingBoxToBox(p))}return u},x.prototype.startAnimation=function(i){var n=this,e=this.getProps(),s=e.drag,o=e.dragMomentum,r=e.dragElastic,a=e.dragTransition,l=e.dragSnapToOrigin,c=e.onDragTransitionEnd,p=this.constraints||{},v=u.eachAxis((function(e){var u;if(y(e,s,n.currentDirection)){var c=null!==(u=null==p?void 0:p[e])&&void 0!==u?u:{};l&&(c={min:0,max:0});var v=r?200:1e6,g=r?40:1e7,d=t.__assign(t.__assign({type:"inertia",velocity:o?i[e]:0,bounceStiffness:v,bounceDamping:g,timeConstant:750,restDelta:1,restSpeed:10},a),c);return n.startAxisValueAnimation(e,d)}}));return Promise.all(v).then(c)},x.prototype.startAxisValueAnimation=function(t,i){var n=this.getAxisMotionValue(t);return v.startAnimation(t,n,0,i)},x.prototype.stopAnimation=function(){var t=this;u.eachAxis((function(i){return t.getAxisMotionValue(i).stop()}))},x.prototype.getAxisMotionValue=function(t){var i,n,e="_drag"+t.toUpperCase(),s=this.visualElement.getProps()[e];return s||this.visualElement.getValue(t,null!==(n=null===(i=this.visualElement.getProps().initial)||void 0===i?void 0:i[t])&&void 0!==n?n:0)},x.prototype.snapToCursor=function(t){var i=this;u.eachAxis((function(n){if(y(n,i.getProps().drag,i.currentDirection)){var e=i.visualElement.projection,s=i.getAxisMotionValue(n);if(e&&e.layout){var o=e.layout.actual[n],r=o.min,a=o.max;s.set(t[n]-f.mix(r,a,.5))}}}))},x.prototype.scalePositionWithinConstraints=function(){var t,i=this,n=this.getProps(),e=n.drag,o=n.dragConstraints,a=this.visualElement.projection;if(s.isRefObject(o)&&a&&this.constraints){this.stopAnimation();var l={x:0,y:0};u.eachAxis((function(t){var n=i.getAxisMotionValue(t);if(n){var e=n.get();l[t]=r.calcOrigin({min:e,max:e},i.constraints[t])}}));var c=this.visualElement.getProps().transformTemplate;this.visualElement.getInstance().style.transform=c?c({},""):"none",null===(t=a.root)||void 0===t||t.updateScroll(),a.updateLayout(),this.resolveConstraints(),u.eachAxis((function(t){if(y(t,e,null)){var n=i.getAxisMotionValue(t),s=i.constraints[t],o=s.min,r=s.max;n.set(f.mix(o,r,l[t]))}}))}},x.prototype.addListeners=function(){var t,i=this;j.set(this.visualElement,this);var n=this.visualElement.getInstance(),e=o.addPointerEvent(n,"pointerdown",(function(t){var n=i.getProps(),e=n.drag,s=n.dragListener;e&&(void 0===s||s)&&i.start(t)})),r=function(){var t=i.getProps().dragConstraints;s.isRefObject(t)&&(i.constraints=i.resolveRefConstraints())},a=this.visualElement.projection,l=a.addEventListener("measure",r);a&&!a.layout&&(null===(t=a.root)||void 0===t||t.updateScroll(),a.updateLayout()),r();var c=d.addDomEvent(window,"resize",(function(){return i.scalePositionWithinConstraints()}));return a.addEventListener("didUpdate",(function(t){var n=t.delta,e=t.hasLayoutChanged;i.isDragging&&e&&(u.eachAxis((function(t){var e=i.getAxisMotionValue(t);e&&(i.originPoint[t]+=n[t].translate,e.set(e.get()+n[t].translate))})),i.visualElement.syncRender())})),function(){c(),e(),l()}},x.prototype.getProps=function(){var i=this.visualElement.getProps(),n=i.drag,e=void 0!==n&&n,s=i.dragDirectionLock,o=void 0!==s&&s,a=i.dragPropagation,l=void 0!==a&&a,u=i.dragConstraints,c=void 0!==u&&u,p=i.dragElastic,v=void 0===p?r.defaultElastic:p,g=i.dragMomentum,d=void 0===g||g;return t.__assign(t.__assign({},i),{drag:e,dragDirectionLock:o,dragPropagation:l,dragConstraints:c,dragElastic:v,dragMomentum:d})},x}();function y(t,i,n){return!(!0!==i&&i!==t||null!==n&&n!==t)}exports.VisualElementDragControls=x,exports.elementDragControls=j;
//# sourceMappingURL=VisualElementDragControls.mjs.js.map
